<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>BugTracker Tests</title>
    <link rel="stylesheet" href="../node_modules/normalize.css/normalize.css" />
    <link rel="stylesheet" href="styles/test.css" />

    <!-- Angular2 stuff -->
    <script src="../node_modules/jquery/dist/jquery.min.js"></script>
    <script src="../node_modules/systemjs/dist/system.src.js"></script>
    <script src="../node_modules/angular2/bundles/angular2-polyfills.js"></script>
    <script src="../node_modules/rxjs/bundles/Rx.js"></script>
    <script src="../node_modules/angular2/bundles/angular2.dev.js"></script>
    <script src="../node_modules/angular2/bundles/router.dev.js"></script>
    <script src="../node_modules/angular2/bundles/http.dev.js"></script>
    <script src="app/systemConfig.js"></script>
    <script src="app/systemConfig.test.js"></script>
    <script type="text/javascript">
        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                results = regex.exec(url);
            if (!results || !results[2]) return null;
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }
        function getTestResultRepresentation(testResult){
            var template = '<div>',
                fixture = testResult.testFixture,
                method = testResult.testMethod;
            
            if (testResult.successful){
                template += '<p class="success"><strong>✔</strong> ';
            }
            else{
                template += '<p class="error"><strong>✖</strong> ';
            }
            template += '<a href="?fixture='+fixture+'">'+fixture+'</a>';
            template += ' - ';
            template += '<a href="?fixture='+fixture+'&method='+method+'">'+method+'</a>';
            template += ' <small>('+testResult.executionTimeMs+'ms)</small>';
            if (!testResult.successful){
                template += '<br>'+testResult.errorMessage;
            }
            template += '</p></div>';
            return $(template);
        }
        function getTitleStatus(testResults){
            if (testResults.failed.length == 0){
                return "✔✔";
            }
            if (testResults.success.length != 0 && testResults.failed.length != 0){
                return "✔✖";
            }
            return "✖✖";
            
        }
        function renderTestResults(testModule){
            var testRunner = new testModule.TestRunner(),
                fixtureFilter = getParameterByName("fixture"),
                methodFilter = getParameterByName("method"),
                testResults = testRunner.execute(fixtureFilter, methodFilter),
                allTestResults = testResults.success.concat(testResults.failed);
            
            document.body.innerText = '';
            var $body = $(document.body),
                $root = $('<div class="testResults">'),
                totalTestCount = testResults.success.length + testResults.failed.length,
                showAllTestsLink = '';
            
            var executionHeader = ' Total time: <strong>'+(allTestResults.reduce(function(sum, testResult){return sum += testResult.executionTimeMs}, 0))+'ms.</strong>';
            var resultHeader = '<h1 class="header">Result: <strong>'+testResults.success.length+' / '+totalTestCount+'</strong> tests passed.'+executionHeader+'</h1>';
            
            if (fixtureFilter || methodFilter){
                showAllTestsLink = '<a href="?">&lt;&lt; Show all tests</a>';
            }
            
            $root.append(resultHeader+showAllTestsLink);
            
            if (testResults.failed.length != 0){
                $root.append('<sub class="errorInfo">Check the console output for more information</sub>');
            }
            document.title = getTitleStatus(testResults) + " - " + document.title;
            
            testResults.failed.forEach(function(testResult){
                var $item = getTestResultRepresentation(testResult);
                $root.append($item);
                console.error(testResult.errorMessage);
            });
            testResults.success.forEach(function(testResult){
                var $item = getTestResultRepresentation(testResult);
                $root.append($item);
            });
            $body.append($root);
        }
    
		System.import("deep-freeze").then(function(deepFreeze){
            System.import("app/tests")
                .then(renderTestResults)
                .catch(function(error) { 
                    document.body.innerText = `Error(s) occurred:\n\n${error.message}\n\nPlease check the console for further details.`;
                    document.body.classList.add('error');
                    console.error(error);
                })
        }).catch(console.log.bind(console));
    </script>
</head>

<body>
    loading...
</body>

</html>